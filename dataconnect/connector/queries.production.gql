# ============================================================================
# EventEase Production Queries
# Firebase Data Connect - Cloud SQL PostgreSQL
# ============================================================================
# 
# Query naming conventions:
# - Get[Entity]ById - Single record by primary key
# - Get[Entity]By[Field] - Single record by unique field
# - List[Entity]s - Multiple records with filters
# - Search[Entity]s - Text search across fields
# - Check[Condition] - Boolean/existence check
# - Get[Entity]Stats - Aggregated statistics
#
# Auth levels:
# - PUBLIC: No authentication required
# - USER: Requires valid Firebase Auth token
# - (Role checks done in application layer)
# ============================================================================

# ============================================================================
# USER QUERIES
# ============================================================================

"""
Get user by database UUID (primary key)
Used for internal lookups after user is known
"""
query GetUserById($id: UUID!) @auth(level: USER) {
  user(id: $id) {
    id
    email
    displayName
    role
    emailDomain
    firstName
    lastName
    year
    division
    department
    rollNo
    avatarUrl
    collegeIdUrl
    phone
    isDeleted
    createdAt
    updatedAt
    lastLoginAt
  }
}

"""
Get user by email address
Primary lookup method since Firebase Auth UID != Database UUID
"""
query GetUserByEmail($email: String!) @auth(level: PUBLIC) {
  users(
    where: { 
      email: { eq: $email },
      isDeleted: { eq: false }
    }, 
    limit: 1
  ) {
    id
    email
    displayName
    role
    firstName
    lastName
    year
    division
    department
    avatarUrl
  }
}

"""
List all users with pagination (admin only)
"""
query ListUsers(
  $role: String
  $limit: Int = 50
  $offset: Int = 0
) @auth(level: USER) {
  users(
    where: { 
      isDeleted: { eq: false },
      role: { eq: $role }
    },
    limit: $limit,
    offset: $offset,
    orderBy: { createdAt: DESC }
  ) {
    id
    email
    displayName
    role
    department
    year
    avatarUrl
    createdAt
  }
}

"""
Search users by name or email (admin only)
"""
query SearchUsers($searchTerm: String!, $limit: Int = 20) @auth(level: USER) {
  users(
    where: {
      isDeleted: { eq: false },
      _or: [
        { displayName: { contains: $searchTerm } },
        { email: { contains: $searchTerm } },
        { firstName: { contains: $searchTerm } },
        { lastName: { contains: $searchTerm } }
      ]
    },
    limit: $limit,
    orderBy: { displayName: ASC }
  ) {
    id
    email
    displayName
    role
    avatarUrl
  }
}

# ============================================================================
# CATEGORY QUERIES
# ============================================================================

"""
List all active categories
"""
query ListCategories @auth(level: PUBLIC) {
  categories(
    where: { isActive: { eq: true } },
    orderBy: { sortOrder: ASC }
  ) {
    id
    name
    description
    icon
    color
    sortOrder
  }
}

"""
Get category by ID
"""
query GetCategoryById($id: UUID!) @auth(level: PUBLIC) {
  category(id: $id) {
    id
    name
    description
    icon
    color
    isActive
  }
}

# ============================================================================
# EVENT QUERIES
# ============================================================================

"""
Get event by ID with full details
"""
query GetEventById($id: UUID!) @auth(level: PUBLIC) {
  event(id: $id) {
    id
    title
    description
    shortDescription
    date
    time
    endTime
    location
    venue
    imageUrl
    categoryId
    category {
      id
      name
      icon
      color
    }
    organizerId
    organizer {
      id
      displayName
      avatarUrl
    }
    capacity
    registeredCount
    waitlistCount
    price
    isFree
    currency
    status
    featured
    requiresApproval
    isPublic
    tags
    averageRating
    totalReviews
    isDeleted
    createdAt
    updatedAt
    publishedAt
  }
}

"""
List published events for public display
"""
query ListPublishedEvents(
  $categoryId: UUID
  $featured: Boolean
  $limit: Int = 50
  $offset: Int = 0
) @auth(level: PUBLIC) {
  events(
    where: {
      isDeleted: { eq: false },
      status: { eq: "published" },
      isPublic: { eq: true },
      categoryId: { eq: $categoryId },
      featured: { eq: $featured }
    },
    limit: $limit,
    offset: $offset,
    orderBy: { date: ASC }
  ) {
    id
    title
    shortDescription
    date
    time
    location
    venue
    imageUrl
    categoryId
    categoryName
    capacity
    registeredCount
    price
    isFree
    featured
    averageRating
    totalReviews
  }
}

"""
List all events (admin view)
"""
query ListEvents(
  $status: String
  $categoryId: UUID
  $organizerId: UUID
  $limit: Int = 50
  $offset: Int = 0
) @auth(level: USER) {
  events(
    where: {
      isDeleted: { eq: false },
      status: { eq: $status },
      categoryId: { eq: $categoryId },
      organizerId: { eq: $organizerId }
    },
    limit: $limit,
    offset: $offset,
    orderBy: { createdAt: DESC }
  ) {
    id
    title
    date
    time
    location
    status
    capacity
    registeredCount
    price
    isFree
    featured
    createdAt
  }
}

"""
List events by organizer
"""
query ListEventsByOrganizer(
  $organizerId: UUID!
  $limit: Int = 50
) @auth(level: USER) {
  events(
    where: {
      isDeleted: { eq: false },
      organizerId: { eq: $organizerId }
    },
    limit: $limit,
    orderBy: { createdAt: DESC }
  ) {
    id
    title
    date
    time
    location
    status
    capacity
    registeredCount
    createdAt
  }
}

"""
Search events by title, description, or location
"""
query SearchEvents(
  $searchTerm: String!
  $status: String = "published"
  $limit: Int = 20
) @auth(level: PUBLIC) {
  events(
    where: {
      isDeleted: { eq: false },
      status: { eq: $status },
      _or: [
        { title: { contains: $searchTerm } },
        { description: { contains: $searchTerm } },
        { location: { contains: $searchTerm } },
        { venue: { contains: $searchTerm } }
      ]
    },
    limit: $limit,
    orderBy: { date: ASC }
  ) {
    id
    title
    shortDescription
    date
    time
    location
    imageUrl
    categoryName
    price
    isFree
  }
}

"""
List upcoming events (next 7 days)
"""
query ListUpcomingEvents(
  $fromDate: Date!
  $toDate: Date!
  $limit: Int = 10
) @auth(level: PUBLIC) {
  events(
    where: {
      isDeleted: { eq: false },
      status: { eq: "published" },
      date: { gte: $fromDate, lte: $toDate }
    },
    limit: $limit,
    orderBy: { date: ASC }
  ) {
    id
    title
    date
    time
    location
    imageUrl
    categoryName
    registeredCount
    capacity
  }
}

"""
List featured events for homepage
"""
query ListFeaturedEvents($limit: Int = 5) @auth(level: PUBLIC) {
  events(
    where: {
      isDeleted: { eq: false },
      status: { eq: "published" },
      featured: { eq: true }
    },
    limit: $limit,
    orderBy: { date: ASC }
  ) {
    id
    title
    shortDescription
    date
    time
    location
    imageUrl
    categoryName
    averageRating
  }
}

# ============================================================================
# BOOKING QUERIES
# ============================================================================

"""
Get booking by ID
"""
query GetBookingById($id: UUID!) @auth(level: USER) {
  booking(id: $id) {
    id
    userId
    user {
      id
      displayName
      email
      avatarUrl
    }
    eventId
    event {
      id
      title
      date
      time
      location
      venue
      imageUrl
    }
    ticketId
    qrCode
    status
    isWaitlist
    waitlistPosition
    numberOfTickets
    totalAmount
    paymentStatus
    paymentId
    checkInTime
    checkedInBy
    checkInMethod
    isDeleted
    createdAt
    updatedAt
  }
}

"""
Get booking by ticket ID (for check-in)
"""
query GetBookingByTicketId($ticketId: String!) @auth(level: USER) {
  bookings(
    where: {
      ticketId: { eq: $ticketId },
      isDeleted: { eq: false }
    },
    limit: 1
  ) {
    id
    userId
    user {
      id
      displayName
      email
      avatarUrl
    }
    eventId
    event {
      id
      title
      date
      time
      venue
    }
    ticketId
    status
    numberOfTickets
    checkInTime
  }
}

"""
Get user's bookings
"""
query GetUserBookings(
  $userId: UUID!
  $status: String
  $limit: Int = 50
) @auth(level: USER) {
  bookings(
    where: {
      userId: { eq: $userId },
      isDeleted: { eq: false },
      status: { eq: $status }
    },
    limit: $limit,
    orderBy: { createdAt: DESC }
  ) {
    id
    eventId
    event {
      id
      title
      date
      time
      location
      venue
      imageUrl
      status
    }
    ticketId
    qrCode
    status
    isWaitlist
    numberOfTickets
    createdAt
  }
}

"""
Get event participants (admin view)
"""
query GetEventParticipants(
  $eventId: UUID!
  $status: String
  $limit: Int = 100
  $offset: Int = 0
) @auth(level: USER) {
  bookings(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      status: { eq: $status }
    },
    limit: $limit,
    offset: $offset,
    orderBy: { createdAt: DESC }
  ) {
    id
    userId
    user {
      id
      displayName
      email
      department
      year
    }
    ticketId
    status
    numberOfTickets
    checkInTime
    createdAt
  }
}

"""
Check if user has existing booking for event
"""
query CheckExistingBooking(
  $userId: UUID!
  $eventId: UUID!
) @auth(level: USER) {
  bookings(
    where: {
      userId: { eq: $userId },
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      status: { in: ["confirmed", "waitlist"] }
    },
    limit: 1
  ) {
    id
    status
  }
}

"""
Get event booking statistics
"""
query GetEventBookingStats($eventId: UUID!) @auth(level: USER) {
  confirmed: bookings_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      status: { eq: "confirmed" }
    }
  ) {
    count
  }
  checkedIn: bookings_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      status: { eq: "checked_in" }
    }
  ) {
    count
  }
  waitlist: bookings_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      status: { eq: "waitlist" }
    }
  ) {
    count
  }
  cancelled: bookings_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      status: { eq: "cancelled" }
    }
  ) {
    count
  }
}

# ============================================================================
# FAVORITE QUERIES
# ============================================================================

"""
Get user's favorite events
"""
query GetUserFavorites($userId: UUID!) @auth(level: USER) {
  favoriteEvents(
    where: { userId: { eq: $userId } },
    orderBy: { createdAt: DESC }
  ) {
    id
    eventId
    event {
      id
      title
      date
      time
      location
      imageUrl
      categoryName
      status
    }
    createdAt
  }
}

"""
Check if event is favorited by user
"""
query CheckIsFavorite(
  $userId: UUID!
  $eventId: UUID!
) @auth(level: USER) {
  favoriteEvents(
    where: {
      userId: { eq: $userId },
      eventId: { eq: $eventId }
    },
    limit: 1
  ) {
    id
  }
}

# ============================================================================
# NOTIFICATION QUERIES
# ============================================================================

"""
Get user's notifications
"""
query GetUserNotifications(
  $userId: UUID!
  $unreadOnly: Boolean = false
  $limit: Int = 50
) @auth(level: USER) {
  notifications(
    where: {
      userId: { eq: $userId },
      read: { eq: $unreadOnly }
    },
    limit: $limit,
    orderBy: { createdAt: DESC }
  ) {
    id
    title
    message
    type
    eventId
    bookingId
    actionUrl
    read
    readAt
    createdAt
  }
}

"""
Get unread notification count
"""
query GetUnreadNotificationCount($userId: UUID!) @auth(level: USER) {
  notifications_aggregate(
    where: {
      userId: { eq: $userId },
      read: { eq: false }
    }
  ) {
    count
  }
}

# ============================================================================
# REVIEW QUERIES
# ============================================================================

"""
Get event reviews with pagination
"""
query GetEventReviews(
  $eventId: UUID!
  $limit: Int = 20
  $offset: Int = 0
) @auth(level: PUBLIC) {
  reviews(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      isApproved: { eq: true }
    },
    limit: $limit,
    offset: $offset,
    orderBy: { createdAt: DESC }
  ) {
    id
    userId
    userName
    userAvatarUrl
    rating
    comment
    isAnonymous
    createdAt
  }
}

"""
Get user's review for an event
"""
query GetUserReview(
  $userId: UUID!
  $eventId: UUID!
) @auth(level: USER) {
  reviews(
    where: {
      userId: { eq: $userId },
      eventId: { eq: $eventId },
      isDeleted: { eq: false }
    },
    limit: 1
  ) {
    id
    rating
    comment
    createdAt
    updatedAt
  }
}

"""
Get review statistics for an event
"""
query GetEventReviewStats($eventId: UUID!) @auth(level: PUBLIC) {
  total: reviews_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      isApproved: { eq: true }
    }
  ) {
    count
    avg { rating }
  }
  fiveStars: reviews_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      isApproved: { eq: true },
      rating: { eq: 5 }
    }
  ) { count }
  fourStars: reviews_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      isApproved: { eq: true },
      rating: { eq: 4 }
    }
  ) { count }
  threeStars: reviews_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      isApproved: { eq: true },
      rating: { eq: 3 }
    }
  ) { count }
  twoStars: reviews_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      isApproved: { eq: true },
      rating: { eq: 2 }
    }
  ) { count }
  oneStar: reviews_aggregate(
    where: {
      eventId: { eq: $eventId },
      isDeleted: { eq: false },
      isApproved: { eq: true },
      rating: { eq: 1 }
    }
  ) { count }
}

# ============================================================================
# CHECK-IN LOG QUERIES
# ============================================================================

"""
Get check-in logs for an event
"""
query GetEventCheckInLogs(
  $eventId: UUID!
  $limit: Int = 100
) @auth(level: USER) {
  checkInLogs(
    where: { eventId: { eq: $eventId } },
    limit: $limit,
    orderBy: { checkedInAt: DESC }
  ) {
    id
    bookingId
    booking {
      ticketId
      user {
        displayName
        email
      }
    }
    checkedInBy
    operator {
      displayName
    }
    method
    checkedInAt
  }
}

# ============================================================================
# ANNOUNCEMENT QUERIES
# ============================================================================

"""
Get announcements for an event
"""
query GetEventAnnouncements($eventId: UUID!) @auth(level: PUBLIC) {
  eventAnnouncements(
    where: { eventId: { eq: $eventId } },
    orderBy: { createdAt: DESC }
  ) {
    id
    title
    message
    priority
    createdBy
    author {
      displayName
    }
    createdAt
  }
}

# ============================================================================
# DASHBOARD / STATISTICS QUERIES
# ============================================================================

"""
Get dashboard statistics for admin
"""
query GetDashboardStats($organizerId: UUID) @auth(level: USER) {
  totalEvents: events_aggregate(
    where: {
      isDeleted: { eq: false },
      organizerId: { eq: $organizerId }
    }
  ) { count }
  
  publishedEvents: events_aggregate(
    where: {
      isDeleted: { eq: false },
      status: { eq: "published" },
      organizerId: { eq: $organizerId }
    }
  ) { count }
  
  totalBookings: bookings_aggregate(
    where: { isDeleted: { eq: false } }
  ) { count }
  
  confirmedBookings: bookings_aggregate(
    where: {
      isDeleted: { eq: false },
      status: { eq: "confirmed" }
    }
  ) { count }
  
  totalRevenue: bookings_aggregate(
    where: {
      isDeleted: { eq: false },
      paymentStatus: { eq: "completed" }
    }
  ) {
    sum { totalAmount }
  }
}

"""
Get recent bookings for dashboard
"""
query GetRecentBookings($limit: Int = 10) @auth(level: USER) {
  bookings(
    where: { isDeleted: { eq: false } },
    limit: $limit,
    orderBy: { createdAt: DESC }
  ) {
    id
    user {
      displayName
      email
    }
    event {
      title
    }
    status
    createdAt
  }
}
